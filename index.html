<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音楽再生デモ</title>
</head>
<body>
  <h1>音楽再生デモ</h1>
  <p id="status">時刻を同期中...</p>
  <button id="start-button">再生を有効化する</button>

  <script>
    // 現在の日付を取得して、指定時刻（例: 今日の20時00分00秒）を設定
    function getTargetTime(hour, minute, second) {
      const now = new Date();
      const targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, second);
      return targetTime.getTime();
    }

    // 現在のNTP時刻を取得
    async function fetchCurrentTime() {
      try {
        const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
        const data = await response.json();
        return new Date(data.utc_datetime).getTime();
      } catch (error) {
        console.error('時刻取得エラー:', error);
        return Date.now();
      }
    }

    async function main() {
      const status = document.getElementById('status');
      const button = document.getElementById('start-button');

      // Web Audio API の初期化
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      let audioBuffer;

      // 音声ファイルのプリロード
      async function preloadAudio() {
        try {
          const response = await fetch('your-audio-file.mp3'); // 音声ファイルのパスを指定
          const arrayBuffer = await response.arrayBuffer();
          audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
          status.textContent = '音声がプリロードされました。';
        } catch (error) {
          console.error('音声プリロードエラー:', error);
          status.textContent = '音声のプリロードに失敗しました。';
        }
      }

      // 音声を再生する
      function playAudioAt(timeToStart) {
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start(timeToStart); // AudioContext の絶対時間で再生開始
      }

      // 今日の20時00分00秒を指定
      const targetTime = getTargetTime(16, 04, 0); // 20:00:00 に設定

      // ボタンのクリックで音楽再生の準備を開始
      button.addEventListener('click', async () => {
        button.disabled = true;

        try {
          // AudioContextをリサンプル（Safariでの再生権限解除対策）
          await audioContext.resume();

          // 音声をプリロード
          await preloadAudio();

          // 現在のNTP時刻を取得
          const ntpTime = await fetchCurrentTime();
          const delay = targetTime - ntpTime;

          if (delay > 0) {
            status.textContent = `再生開始まで: ${Math.round(delay / 1000)}秒`;

            // 再生開始時間をAudioContextの現在時間から計算
            const playbackTime = audioContext.currentTime + delay / 1000;

            // 再生をスケジュール
            setTimeout(() => {
              playAudioAt(playbackTime);
              status.textContent = '再生中';
            }, delay);
          } else {
            status.textContent = '指定時刻が過ぎています。';
          }
        } catch (error) {
          status.textContent = 'エラーが発生しました: ' + error.message;
        }
      });
    }

    main();
  </script>
</body>
</html>
