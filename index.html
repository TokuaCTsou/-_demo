<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音楽再生デモ</title>
</head>
<body>
  <h1>音楽再生デモ</h1>
  <p id="status">時刻を同期中...</p>
  <button id="start-button">再生を有効化する</button>

  <script>
    // Safari対応のAudioContext
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let audioBuffer;

    // Safari制限解除: 無音再生
    async function unlockAudioContext() {
      const silentSource = audioContext.createBufferSource();
      const buffer = audioContext.createBuffer(1, 1, audioContext.sampleRate);
      silentSource.buffer = buffer;
      silentSource.connect(audioContext.destination);
      silentSource.start(0);
      await silentSource.stop(0); // 無音の一瞬再生
      console.log('AudioContext unlocked.');
    }

    // 音声ファイルのプリロード
    async function preloadAudio() {
      try {
        const response = await fetch('your-audio-file.mp3'); // WAV形式を推奨
        const arrayBuffer = await response.arrayBuffer();
        audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        document.getElementById('status').textContent = '音声がプリロードされました。';
      } catch (error) {
        console.error('音声プリロードエラー:', error);
        document.getElementById('status').textContent = '音声のプリロードに失敗しました。';
      }
    }

    // 音声を再生する
    function playAudioAt(timeToStart) {
      const source = audioContext.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(audioContext.destination);
      source.start(timeToStart);
      console.log('Audio playback started at:', timeToStart);
    }

    // NTP時刻の取得
    async function fetchCurrentTime() {
      try {
        const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
        const data = await response.json();
        return new Date(data.utc_datetime).getTime();
      } catch (error) {
        console.error('時刻取得エラー:', error);
        return Date.now();
      }
    }

    // 指定時刻を取得
    function getTargetTime(hour, minute, second) {
      const now = new Date();
      const targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, second);
      return targetTime.getTime();
    }

    async function main() {
      const status = document.getElementById('status');
      const button = document.getElementById('start-button');

      button.addEventListener('click', async () => {
        try {
          // AudioContextの再開
          await audioContext.resume();

          // Safariの制限解除
          await unlockAudioContext();

          // 音声ファイルのプリロード
          await preloadAudio();

          // NTP時刻取得
          const ntpTime = await fetchCurrentTime();
          const targetTime = getTargetTime(16, 25, 0); // 今日の20時00分00秒
          const delay = targetTime - ntpTime;

          if (delay > 0) {
            status.textContent = `再生開始まで: ${Math.round(delay / 1000)}秒`;

            const playbackTime = audioContext.currentTime + delay / 1000;
            setTimeout(() => {
              playAudioAt(playbackTime);
              status.textContent = '再生中';
            }, delay);
          } else {
            status.textContent = '指定時刻が過ぎています。';
          }
        } catch (error) {
          console.error('エラー:', error);
          status.textContent = 'エラーが発生しました: ' + error.message;
        }
      });
    }

    main();
  </script>
</body>
</html>
